<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ToolDAQFramework: ZSTD_cwksp Struct Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ToolDAQFramework
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-attribs">Public Attributes</a> &#124;
<a href="structZSTD__cwksp-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">ZSTD_cwksp Struct Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-attribs"></a>
Public Attributes</h2></td></tr>
<tr class="memitem:aaf997d6b32f18dee07fcbe9452d37062"><td class="memItemLeft" align="right" valign="top"><a id="aaf997d6b32f18dee07fcbe9452d37062"></a>
void *&#160;</td><td class="memItemRight" valign="bottom"><b>workspace</b></td></tr>
<tr class="separator:aaf997d6b32f18dee07fcbe9452d37062"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0cbea25172e7dc9c1ac2fbae0e539e74"><td class="memItemLeft" align="right" valign="top"><a id="a0cbea25172e7dc9c1ac2fbae0e539e74"></a>
void *&#160;</td><td class="memItemRight" valign="bottom"><b>workspaceEnd</b></td></tr>
<tr class="separator:a0cbea25172e7dc9c1ac2fbae0e539e74"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8156e41d1ff6c92ceaa75edb56619017"><td class="memItemLeft" align="right" valign="top"><a id="a8156e41d1ff6c92ceaa75edb56619017"></a>
void *&#160;</td><td class="memItemRight" valign="bottom"><b>objectEnd</b></td></tr>
<tr class="separator:a8156e41d1ff6c92ceaa75edb56619017"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a24b2a3ebbb454fa0154ae74f27a89594"><td class="memItemLeft" align="right" valign="top"><a id="a24b2a3ebbb454fa0154ae74f27a89594"></a>
void *&#160;</td><td class="memItemRight" valign="bottom"><b>tableEnd</b></td></tr>
<tr class="separator:a24b2a3ebbb454fa0154ae74f27a89594"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a05a28e3c713b260601997c8dd31833ea"><td class="memItemLeft" align="right" valign="top"><a id="a05a28e3c713b260601997c8dd31833ea"></a>
void *&#160;</td><td class="memItemRight" valign="bottom"><b>tableValidEnd</b></td></tr>
<tr class="separator:a05a28e3c713b260601997c8dd31833ea"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad11c6fcee8a2e1562b754122b3afe165"><td class="memItemLeft" align="right" valign="top"><a id="ad11c6fcee8a2e1562b754122b3afe165"></a>
void *&#160;</td><td class="memItemRight" valign="bottom"><b>allocStart</b></td></tr>
<tr class="separator:ad11c6fcee8a2e1562b754122b3afe165"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7c1394ca81fb2f53940cc9e4f2a9a00c"><td class="memItemLeft" align="right" valign="top"><a id="a7c1394ca81fb2f53940cc9e4f2a9a00c"></a>
void *&#160;</td><td class="memItemRight" valign="bottom"><b>initOnceStart</b></td></tr>
<tr class="separator:a7c1394ca81fb2f53940cc9e4f2a9a00c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a64b34ee7fcf6317ef3daee1f89dd8dc8"><td class="memItemLeft" align="right" valign="top"><a id="a64b34ee7fcf6317ef3daee1f89dd8dc8"></a>
BYTE&#160;</td><td class="memItemRight" valign="bottom"><b>allocFailed</b></td></tr>
<tr class="separator:a64b34ee7fcf6317ef3daee1f89dd8dc8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1e78a023a5bd52056393ac6f3f1e80ae"><td class="memItemLeft" align="right" valign="top"><a id="a1e78a023a5bd52056393ac6f3f1e80ae"></a>
int&#160;</td><td class="memItemRight" valign="bottom"><b>workspaceOversizedDuration</b></td></tr>
<tr class="separator:a1e78a023a5bd52056393ac6f3f1e80ae"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a73353689bb49ac0d357c3ff3c19e44e6"><td class="memItemLeft" align="right" valign="top"><a id="a73353689bb49ac0d357c3ff3c19e44e6"></a>
ZSTD_cwksp_alloc_phase_e&#160;</td><td class="memItemRight" valign="bottom"><b>phase</b></td></tr>
<tr class="separator:a73353689bb49ac0d357c3ff3c19e44e6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afe45ebf762506746035f34ad51346852"><td class="memItemLeft" align="right" valign="top"><a id="afe45ebf762506746035f34ad51346852"></a>
<a class="el" href="zstd_8c.html#a1df52ae5f2538c70f0db6f9c9377f6c7">ZSTD_cwksp_static_alloc_e</a>&#160;</td><td class="memItemRight" valign="bottom"><b>isStatic</b></td></tr>
<tr class="separator:afe45ebf762506746035f34ad51346852"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Zstd fits all its internal datastructures into a single continuous buffer, so that it only needs to perform a single OS allocation (or so that a buffer can be provided to it and it can perform no allocations at all). This buffer is called the workspace.</p>
<p>Several optimizations complicate that process of allocating memory ranges from this workspace for each internal datastructure:</p>
<ul>
<li>These different internal datastructures have different setup requirements:<ul>
<li>The static objects need to be cleared once and can then be trivially reused for each compression.</li>
<li>Various buffers don't need to be initialized at all&ndash;they are always written into before they're read.</li>
<li>The matchstate tables have a unique requirement that they don't need their memory to be totally cleared, but they do need the memory to have some bound, i.e., a guarantee that all values in the memory they've been allocated is less than some maximum value (which is the starting value for the indices that they will then use for compression). When this guarantee is provided to them, they can use the memory without any setup work. When it can't, they have to clear the area.</li>
</ul>
</li>
<li>These buffers also have different alignment requirements.</li>
<li>We would like to reuse the objects in the workspace for multiple compressions without having to perform any expensive reallocation or reinitialization work.</li>
<li>We would like to be able to efficiently reuse the workspace across multiple compressions <b>even when the compression parameters change</b> and we need to resize some of the objects (where possible).</li>
</ul>
<p>To attempt to manage this buffer, given these constraints, the <a class="el" href="structZSTD__cwksp.html">ZSTD_cwksp</a> abstraction was created. It works as follows:</p>
<p>Workspace Layout:</p>
<p>[ ... workspace ... ] [objects][tables -&gt;] free space [&lt;- buffers][&lt;- aligned][&lt;- init once]</p>
<p>The various objects that live in the workspace are divided into the following categories, and are allocated separately:</p>
<ul>
<li>Static objects: this is optionally the enclosing ZSTD_CCtx or ZSTD_CDict, so that literally everything fits in a single buffer. Note: if present, this must be the first object in the workspace, since ZSTD_customFree{CCtx, CDict}() rely on a pointer comparison to see whether one or two frees are required.</li>
<li>Fixed size objects: these are fixed-size, fixed-count objects that are nonetheless "dynamically" allocated in the workspace so that we can control how they're initialized separately from the broader ZSTD_CCtx. Examples:<ul>
<li>Entropy Workspace</li>
<li>2 x <a class="el" href="structZSTD__compressedBlockState__t.html">ZSTD_compressedBlockState_t</a></li>
<li>CDict dictionary contents</li>
</ul>
</li>
<li>Tables: these are any of several different datastructures (hash tables, chain tables, binary trees) that all respect a common format: they are uint32_t arrays, all of whose values are between 0 and (nextSrc - base). Their sizes depend on the cparams. These tables are 64-byte aligned.</li>
<li>Init once: these buffers require to be initialized at least once before use. They should be used when we want to skip memory initialization while not triggering memory checkers (like Valgrind) when reading from from this memory without writing to it first. These buffers should be used carefully as they might contain data from previous compressions. Buffers are aligned to 64 bytes.</li>
<li>Aligned: these buffers don't require any initialization before they're used. The user of the buffer should make sure they write into a buffer location before reading from it. Buffers are aligned to 64 bytes.</li>
<li>Buffers: these buffers are used for various purposes that don't require any alignment or initialization before they're used. This means they can be moved around at no cost for a new compression.</li>
</ul>
<p>Allocating Memory:</p>
<p>The various types of objects must be allocated in order, so they can be correctly packed into the workspace buffer. That order is:</p>
<ol type="1">
<li>Objects</li>
<li>Init once / Tables</li>
<li>Aligned / Tables</li>
<li>Buffers / Tables</li>
</ol>
<p>Attempts to reserve objects of different types out of order will fail. </p>
</div><hr/>The documentation for this struct was generated from the following file:<ul>
<li>src/ServiceDiscovery/<a class="el" href="zstd_8c.html">zstd.c</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
